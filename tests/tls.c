#include <stdio.h>
#include <string.h>
#include <assert.h>
#include "tls.h"

struct test_packet {
    const uint8_t *packet;
    int len;
};

const uint8_t good_data_1[] = { 0x16, 0x03, 0x01, 0x00, 0x68,
    0x01, 0x00, 0x00, 0x64, 0x03, 0x01, 0x4e, 0x55, 0xde, 0x32,
    0x80, 0x07, 0x92, 0x9f, 0x50, 0x41, 0xe4, 0xf9, 0x58, 0x32,
    0xfc, 0x4f, 0x10, 0xb3, 0xde, 0x44, 0x4d, 0xa9, 0x67, 0x78,
    0xea, 0xd1, 0x5f, 0x29, 0x09, 0x04, 0xc1, 0x06, 0x00, 0x00,
    0x28, 0x00, 0x39, 0x00, 0x38, 0x00, 0x35, 0x00, 0x16, 0x00,
    0x13, 0x00, 0x0a, 0x00, 0x33, 0x00, 0x32, 0x00, 0x2f, 0x00,
    0x05, 0x00, 0x04, 0x00, 0x15, 0x00, 0x12, 0x00, 0x09, 0x00,
    0x14, 0x00, 0x11, 0x00, 0x08, 0x00, 0x06, 0x00, 0x03, 0x00,
    0xff, 0x02, 0x01, 0x00, 0x00, 0x12, 0x00, 0x00, 0x00, 0x0e,
    0x00, 0x0c, 0x00, 0x00, 0x09, 0x6c, 0x6f, 0x63, 0x61, 0x6c,
    0x68, 0x6f, 0x73, 0x74 };

const uint8_t bad_data_1[] = { 0x16, 0x03, 0x01, 0x00,
            0x68, 0x01, 0x00, 0x00, 0x64, 0x03, 0x01, 0x4e,
            0x4e, 0xbe, 0xc2, 0xa1, 0x21, 0xad, 0xbc, 0x28,
            0x33, 0xca, 0xa1, 0xd6, 0x6e, 0x57, 0xb9, 0x1f,
            0x8c, 0x19, 0x0e, 0x44, 0x16, 0x9e, 0x7d, 0x20,
            0x35, 0x4b, 0x65, 0xb2, 0xc0, 0xd5, 0xa8, 0x00,
            0x00, 0x28, 0x00, 0x39, 0x00, 0x38, 0x00, 0x35,
            0x00, 0x16, 0x00, 0x13, 0x00, 0x0a, 0x00, 0x33,
            0x00, 0x32, 0x00, 0x2f, 0x00, 0x05, 0x00, 0x04,
            0x00, 0x15, 0x00, 0x12, 0x00, 0x09, 0x00, 0x14,
            0x00, 0x11, 0x00, 0x08, 0x00, 0x06, 0x00, 0x03,
            0x00, 0xff, 0x02, 0x01, 0x00, 0x00, 0x12, 0x00,
            0x00, 0x00, 0x0e, 0x00, 0x0c, 0x00, 0x00, 0x09,
            0x6c, 0x6f, 0x64, 0x61, 0x6c, 0x68, 0x6f, 0x73,
            0x74 };

const uint8_t bad_data_2[] = { 0x16, 0x03, 0x01, 0x00,
            0x68, 0x01, 0x00, 0x00, 0x64, 0x03, 0x01, 0x4e,
            0x4e, 0xbe, 0xc2, 0xa1, 0x21, 0xad, 0xbc, 0x28,
            0x33, 0xca, 0xa1, 0xd6, 0x6e, 0x57, 0xb9, 0x1f,
            0x8c, 0x19, 0x0e, 0x44, 0x16, 0x9e, 0x7d, 0x20,
            0x35, 0x4b, 0x65, 0xb2, 0xc0, 0xd5, 0xa8, 0x00,
            0x00, 0x28, 0x00, 0x39, 0x00, 0x38, 0x00, 0x35,
            0x00, 0x16, 0x00, 0x13, 0x00, 0x0a, 0x00, 0x33,
            0x00, 0x32, 0x00, 0x2f, 0x00, 0x05, 0x00, 0x04,
            0x00, 0x15, 0x00, 0x12, 0x00, 0x09, 0x00, 0x14,
            0x00, 0x11, 0x00, 0x08, 0x00, 0x06, 0x00, 0x03,
            0x00, 0xff, 0x02, 0x01, 0x00, 0x00, 0x12, 0x00,
            0x00, 0x00, 0x0e, 0x00 };

struct test_packet good[] = {
    { good_data_1, sizeof(good_data_1) }
};

struct test_packet bad[] = {
    { bad_data_1, sizeof(bad_data_1) },
    { bad_data_2, sizeof(bad_data_2) }
};

int main() {
    unsigned int i;
    const char *hostname;

    for(i = 0; i < sizeof(good) / sizeof(struct test_packet); i++) {
        hostname = parse_tls_header(good[i].packet, good[i].len);

        assert(NULL != hostname);

        assert(0 == strcmp("localhost", hostname));
    }

    for(i = 0; i < sizeof(bad) / sizeof(struct test_packet); i++) {
        hostname = parse_tls_header(bad[i].packet, bad[i].len);
    }

    return 0;
}

