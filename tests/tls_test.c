#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <assert.h>
#include "tls.h"


struct Test {
    const char *packet;
    int packet_len;
    struct TLSProtocol **tls_data_ptr;
    const char *expected_name;
};

struct TLSProtocol *tls_sni_data;
struct TLSProtocol *tls_alpn_data;

const unsigned char good_data_1[] = {
    // TLS record
    0x16, // Content Type: Handshake
    0x03, 0x01, // Version: TLS 1.0
    0x00, 0x68, // Length
        // Handshake
        0x01, // Handshake Type: Client Hello
        0x00, 0x00, 0x64,  // Length
        0x03, 0x01, // Version: TLS 1.0
        // Random
        0x4e, 0x55, 0xde, 0x32, 0x80, 0x07, 0x92, 0x9f,
        0x50, 0x41, 0xe4, 0xf9, 0x58, 0x32, 0xfc, 0x4f,
        0x10, 0xb3, 0xde, 0x44, 0x4d, 0xa9, 0x67, 0x78,
        0xea, 0xd1, 0x5f, 0x29, 0x09, 0x04, 0xc1, 0x06,
        0x00, // Session ID Length
        0x00, 0x28, // Cipher Suites Length
            0x00, 0x39,
            0x00, 0x38,
            0x00, 0x35,
            0x00, 0x16,
            0x00, 0x13,
            0x00, 0x0a,
            0x00, 0x33,
            0x00, 0x32,
            0x00, 0x2f,
            0x00, 0x05,
            0x00, 0x04,
            0x00, 0x15,
            0x00, 0x12,
            0x00, 0x09,
            0x00, 0x14,
            0x00, 0x11,
            0x00, 0x08,
            0x00, 0x06,
            0x00, 0x03,
            0x00, 0xff,
        0x02, // Compression Methods
            0x01,
            0x00,
        0x00, 0x12, // Extensions Length
            0x00, 0x00, // Extension Type: Server Name
            0x00, 0x0e, // Length
            0x00, 0x0c, // Server Name Indication Length
                0x00, // Server Name Type: host_name
                0x00, 0x09, // Length
                // "localhost"
                0x6c, 0x6f, 0x63, 0x61, 0x6c, 0x68, 0x6f, 0x73, 0x74
};

const unsigned char good_data_2[] = {
    // TLS record
    0x16, // Content Type: Handshake
    0x03, 0x01, // Version: TLS 1.0
    0x00, 0x48, // Length
        // Handshake
        0x01, // Handshake Type: Client Hello
        0x00, 0x00, 0x42, // Length
        0x03, 0x03, // Version: TLS 1.2
        // Random
        0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
        0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
        0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
        0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
        0x00, // Session ID Length
        0x00, 0x04, // Cipher Suites Length
            0x00, 0x01, // NULL-MD5
            0x00, 0xff, // RENEGOTIATION INFO SCSV
        0x01, // Compression Methods
            0x00, // NULL
        0x00, 0x17, // Extensions Length
            // Extension
            0x00, 0x00, // Extension Type: Server Name
            0x00, 0x0e, // Length
            0x00, 0x0c, // Server Name Indication Length
                0x00, // Server Name Type: host_name
                0x00, 0x09, // Length
                // "localhost"
                0x6c, 0x6f, 0x63, 0x61, 0x6c, 0x68, 0x6f, 0x73, 0x74,
            // Extension
            0x00, 0x0f, // Extension Type: Heart Beat
            0x00, 0x01, // Length
            0x01 // Mode: Peer allows to send requests
};

const unsigned char good_data_3[] = {
    // Testing different extension order
    // TLS record
    0x16, // Content Type: Handshake
    0x03, 0x01, // Version: TLS 1.0
    0x00, 0x48, // Length
        // Handshake
        0x01, // Handshake Type: Client Hello
        0x00, 0x00, 0x42, // Length
        0x03, 0x03, // Version: TLS 1.2
        // Random
        0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
        0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
        0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
        0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
        0x00, // Session ID Length
        0x00, 0x04, // Cipher Suites Length
            0x00, 0x01, // NULL-MD5
            0x00, 0xff, // RENEGOTIATION INFO SCSV
        0x01, // Compression Methods
            0x00, // NULL
        0x00, 0x17, // Extensions Length
            // Extension
            0x00, 0x0f, // Extension Type: Heart Beat
            0x00, 0x01, // Length
            0x01, // Mode: Peer allows to send requests
            // Extension
            0x00, 0x00, // Extension Type: Server Name
            0x00, 0x0e, // Length
            0x00, 0x0c, // Server Name Indication Length
                0x00, // Server Name Type: host_name
                0x00, 0x09, // Length
                // "localhost"
                0x6c, 0x6f, 0x63, 0x61, 0x6c, 0x68, 0x6f, 0x73, 0x74
};

const unsigned char good_data_4[] = {
    // TLS record
    0x16, // Content Type: Handshake
    0x03, 0x01, // Version: TLS 1.0
    0x00, 0x47, // Length
        // Handshake
        0x01, // Handshake Type: Client Hello
        0x00, 0x00, 0x41, // Length
        0x03, 0x03, // Version: TLS 1.2
        // Random
        0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
        0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
        0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
        0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
        0x00, // Session ID Length
        0x00, 0x04, // Cipher Suites Length
            0x00, 0x01, // NULL-MD5
            0x00, 0xff, // RENEGOTIATION INFO SCSV
        0x01, // Compression Methods
            0x00, // NULL
        0x00, 0x16, // Extensions Length
            // Extension
            0x00, 0x00, // Extension Type: Server Name
            0x00, 0x0e, // Length
            0x00, 0x0c, // Server Name Indication Length
                0x00, // Server Name Type: host_name
                0x00, 0x09, // Length
                // "localhost"
                0x6c, 0x6f, 0x63, 0x61, 0x6c, 0x68, 0x6f, 0x73, 0x74,
            // Extension
            0x00, 0x23, // Extension Type: Session Ticket TLS
            0x00, 0x00, // Length
};

const unsigned char alpn_good_data_1[] = {
    // TLS record
    0x16, // Content Type: Handshake
    0x03, 0x00, // Version: SSL 3.0
    0x01, 0x16, // Length
        // Handshake
        0x01, // Handshake Type: Client Hello
        0x00, 0x01, 0x12, // Length
        0x03, 0x03, // Version: TLS 1.2
        // Random
        0x53, 0x03, 0x59, 0x03, 0xa8, 0xb2, 0xa9, 0x36,
        0x4c, 0x2d, 0x04, 0x72, 0x4f, 0xea, 0x98, 0xd5,
        0xb5, 0xbb, 0xea, 0x07, 0x4f, 0x00, 0x83, 0x1c,
        0xfa, 0xa0, 0x01, 0xcc, 0x7d, 0x2f, 0x4f, 0x6f,
        0x00, // Session ID Length
        0x00, 0x84, // Cipher Suites Length
            0xc0, 0x2b,
            0xc0, 0x2c,
            0xc0, 0x86,
            0xc0, 0x87,
            0xc0, 0x09,
            0xc0, 0x23,
            0xc0, 0x0a,
            0xc0, 0x24,
            0xc0, 0x72,
            0xc0, 0x73,
            0xc0, 0x08,
            0xc0, 0x07,
            0xc0, 0x2f,
            0xc0, 0x30,
            0xc0, 0x8a,
            0xc0, 0x8b,
            0xc0, 0x13,
            0xc0, 0x27,
            0xc0, 0x14,
            0xc0, 0x28,
            0xc0, 0x76,
            0xc0, 0x77,
            0xc0, 0x12,
            0xc0, 0x11,
            0x00, 0x9c,
            0x00, 0x9d,
            0xc0, 0x7a,
            0xc0, 0x7b,
            0x00, 0x2f,
            0x00, 0x3c,
            0x00, 0x35,
            0x00, 0x3d,
            0x00, 0x41,
            0x00, 0xba,
            0x00, 0x84,
            0x00, 0xc0,
            0x00, 0x0a,
            0x00, 0x05,
            0x00, 0x04,
            0x00, 0x9e,
            0x00, 0x9f,
            0xc0, 0x7c,
            0xc0, 0x7d,
            0x00, 0x33,
            0x00, 0x67,
            0x00, 0x39,
            0x00, 0x6b,
            0x00, 0x45,
            0x00, 0xbe,
            0x00, 0x88,
            0x00, 0xc4,
            0x00, 0x16,
            0x00, 0xa2,
            0x00, 0xa3,
            0xc0, 0x80,
            0xc0, 0x81,
            0x00, 0x32,
            0x00, 0x40,
            0x00, 0x38,
            0x00, 0x6a,
            0x00, 0x44,
            0x00, 0xbd,
            0x00, 0x87,
            0x00, 0xc3,
            0x00, 0x13,
            0x00, 0x66,
            0x01, // Compression Methods
                0x00, // NULL
            0x00, 0x65, // Extensions Length
                // Extension
                0x00, 0x05,
                0x00, 0x05,
                0x01, 0x00, 0x00, 0x00, 0x00,
                // Extension
                0x00, 0x00, // Extension Type: Server Name
                0x00, 0x0e, // Length
                0x00, 0x0c, // Server Name Indication Length
                    0x00, // Server Name Type: host_name
                    0x00, 0x09, // Length
                    // "localhost"
                    0x6c, 0x6f, 0x63, 0x61, 0x6c, 0x68, 0x6f, 0x73, 0x74,
                // Extension
                0xff, 0x01,
                0x00, 0x01,
                0x00,
                // Extension
                0x00, 0x23,
                0x00, 0x00,
                // Extension
                0x00, 0x0a,
                0x00, 0x08,
                0x00, 0x06, 0x00, 0x17, 0x00, 0x18, 0x00, 0x19,
                // Extension
                0x00, 0x0b,
                0x00, 0x02,
                0x01, 0x00,
                // Extension
                0x00, 0x0d,
                0x00, 0x1c,
                0x00, 0x1a, 0x04, 0x01, 0x04, 0x02, 0x04, 0x03,
                0x05, 0x01, 0x05, 0x03, 0x06, 0x01, 0x06, 0x03,
                0x03, 0x01, 0x03, 0x02, 0x03, 0x03, 0x02, 0x01,
                0x02, 0x02, 0x02, 0x03,
                // Extension
                0x00, 0x10, // Extension Type: ALPN
                0x00, 0x0b,
                0x00, 0x09,
                    0x08, // Length
                    // "http/2.0"
                    0x68, 0x74, 0x74, 0x70, 0x2f, 0x32, 0x2e, 0x30
};

const unsigned char ssl30_request[] = {
    // TLS record
    0x16, // Content Type: Handshake
    0x03, 0x00, // Version: SSL 3.0
    0x00, 0x7f, // Length
        // Handshake
        0x01, // Handshake Type: Client Hello
        0x00, 0x00, 0x7b, // Length
        0x03, 0x00, // Version: SSL 3.0
        // Random
        0x53, 0x11, 0x25, 0xc2, 0x92, 0xd6, 0xca, 0xf1,
        0x79, 0x90, 0xba, 0x38, 0x8f, 0xad, 0xc8, 0x13,
        0xa3, 0x1b, 0x57, 0xd9, 0xf4, 0x3e, 0xd2, 0x8b,
        0xb6, 0x5e, 0xe3, 0x12, 0xca, 0x81, 0x2f, 0xc5,
        0x00, // Session ID Length
        0x00, 0x54, // Cipher Suites Length
            0xc0, 0x14,
            0xc0, 0x0a,
            0xc0, 0x22,
            0xc0, 0x21,
            0x00, 0x39,
            0x00, 0x38,
            0xc0, 0x0f,
            0xc0, 0x05,
            0x00, 0x35,
            0xc0, 0x12,
            0xc0, 0x08,
            0xc0, 0x1c,
            0xc0, 0x1b,
            0x00, 0x16,
            0x00, 0x13,
            0xc0, 0x0d,
            0xc0, 0x03,
            0x00, 0x0a,
            0xc0, 0x13,
            0xc0, 0x09,
            0xc0, 0x1f,
            0xc0, 0x1e,
            0x00, 0x33,
            0x00, 0x32,
            0xc0, 0x0e,
            0xc0, 0x04,
            0x00, 0x2f,
            0xc0, 0x11,
            0xc0, 0x07,
            0xc0, 0x0c,
            0xc0, 0x02,
            0x00, 0x05,
            0x00, 0x04,
            0x00, 0x15,
            0x00, 0x12,
            0x00, 0x09,
            0x00, 0x14,
            0x00, 0x11,
            0x00, 0x08,
            0x00, 0x06,
            0x00, 0x03,
            0x00, 0xff,
        0x01, // Compression Methods
            0x00
};

const unsigned char bad_data_1[] = {
    0x16, 0x03, 0x01, 0x00, 0x68, 0x01, 0x00, 0x00,
    0x64, 0x03, 0x01, 0x4e, 0x4e, 0xbe, 0xc2, 0xa1,
    0x21, 0xad, 0xbc, 0x28, 0x33, 0xca, 0xa1, 0xd6,
    0x6e, 0x57, 0xb9, 0x1f, 0x8c, 0x19, 0x0e, 0x44,
    0x16, 0x9e, 0x7d, 0x20, 0x35, 0x4b, 0x65, 0xb2,
    0xc0, 0xd5, 0xa8, 0x00, 0x00, 0x28, 0x00, 0x39,
    0x00, 0x38, 0x00, 0x35, 0x00, 0x16, 0x00, 0x13,
    0x00, 0x0a, 0x00, 0x33, 0x00, 0x32, 0x00, 0x2f,
    0x00, 0x05, 0x00, 0x04, 0x00, 0x15, 0x00, 0x12,
    0x00, 0x09, 0x00, 0x14, 0x00, 0x11, 0x00, 0x08,
    0x00, 0x06, 0x00, 0x03, 0x00, 0xff, 0x02, 0x01,
    0x00, 0x00, 0x12, 0x00, 0x00, 0x00, 0x0e, 0x00,
    0x0c, 0x00, 0x00, 0x09, 0x6c, 0x6f, 0x64, 0x61,
    0x6c, 0x68, 0x6f, 0x73, 0x74
};

const unsigned char bad_data_2[] = {
    0x16, 0x03, 0x01, 0x00, 0x68, 0x01, 0x00, 0x00,
    0x64, 0x03, 0x01, 0x4e, 0x4e, 0xbe, 0xc2, 0xa1,
    0x21, 0xad, 0xbc, 0x28, 0x33, 0xca, 0xa1, 0xd6,
    0x6e, 0x57, 0xb9, 0x1f, 0x8c, 0x19, 0x0e, 0x44,
    0x16, 0x9e, 0x7d, 0x20, 0x35, 0x4b, 0x65, 0xb2,
    0xc0, 0xd5, 0xa8, 0x00, 0x00, 0x28, 0x00, 0x39,
    0x00, 0x38, 0x00, 0x35, 0x00, 0x16, 0x00, 0x13,
    0x00, 0x0a, 0x00, 0x33, 0x00, 0x32, 0x00, 0x2f,
    0x00, 0x05, 0x00, 0x04, 0x00, 0x15, 0x00, 0x12,
    0x00, 0x09, 0x00, 0x14, 0x00, 0x11, 0x00, 0x08,
    0x00, 0x06, 0x00, 0x03, 0x00, 0xff, 0x02, 0x01,
    0x00, 0x00, 0x12, 0x00, 0x00, 0x00, 0x0e, 0x00
};

const unsigned char bad_data_3[] = {
    0x16, 0x03, 0x01, 0x00
};

const unsigned char bad_data_4[] = {
    // TLS record
    0x16, // Content Type: Handshake
    0x03, 0x01, // Version: TLS 1.0
    0x00, 0x48, // Length
        // Handshake
        0x01, // Handshake Type: Client Hello
        0x00, 0x00, 0x42, // Length
        0x03, 0x03, // Version: TLS 1.2
        // Random
        0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
        0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
        0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
        0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
        0x00, // Session ID Length
        0x00, 0x04, // Cipher Suites Length
            0x00, 0x01, // NULL-MD5
            0x00, 0xff, // RENEGOTIATION INFO SCSV
        0x01, // Compression Methods
            0x00, // NULL
        0x00, 0x17, // Extensions Length
            // Extension
            0x00, 0x00, // Extension Type: Server Name
            0x00, 0x0e, // Length
            0x00, 0x0c, // Server Name Indication Length
                0x00, // Server Name Type: host_name
                0x00, 0x09, // Length
                // "localhost"
                0x6c, 0x6f, 0x63, 0x61, 0x6c, 0x68, 0x6f, 0x73, 0x74,
            // Extension
            0x00, 0x0f, // Extension Type: Heart Beat
            0x00, 0x01, // Length
            0x01 // Mode: Peer allows to send requests
};

static struct Test good[] = {
    { (char *)good_data_1, sizeof(good_data_1), &tls_sni_data, "localhost" },
    { (char *)good_data_2, sizeof(good_data_2), &tls_sni_data, "localhost" },
    { (char *)good_data_3, sizeof(good_data_3), &tls_sni_data, "localhost" },
    { (char *)good_data_4, sizeof(good_data_4), &tls_sni_data, "localhost" },
    { (char *)alpn_good_data_1, sizeof(alpn_good_data_1), &tls_alpn_data, "http/2.0" }
};

static struct Test bad[] = {
    { (char *)ssl30_request, sizeof(ssl30_request), NULL },
    { (char *)bad_data_1, sizeof(bad_data_1), NULL },
    { (char *)bad_data_2, sizeof(bad_data_2), NULL },
    { (char *)bad_data_3, sizeof(bad_data_3), NULL }
};

int main() {
    tls_sni_data = new_tls_data();
    assert(tls_sni_data != NULL);
    tls_alpn_data = new_tls_data();
    assert(tls_alpn_data != NULL);
    tls_alpn_data = tls_data_append_alpn_protocol(tls_alpn_data, "http/1.1", 8);
    assert(tls_alpn_data != NULL);
    tls_alpn_data = tls_data_append_alpn_protocol(tls_alpn_data, "http/2.0", 8);
    assert(tls_alpn_data != NULL);
    tls_alpn_data = tls_data_append_alpn_protocol(tls_alpn_data, "spdy/3", 6);
    assert(tls_alpn_data != NULL);
    tls_alpn_data = tls_data_use_alpn(tls_alpn_data, 1);

    for (struct Test *test = good; test < good + sizeof(good) / sizeof(struct Test); test++) {
        char *hostname = NULL;

        int result = tls_protocol->parse_packet(*test->tls_data_ptr, test->packet, test->packet_len, &hostname);

        assert(result == strlen(test->expected_name));

        assert(NULL != hostname);

        if (strcmp(test->expected_name, hostname) != 0) {
            fprintf(stderr, "test received \"%s\", expected \"%s\"\n", hostname, test->expected_name);
            assert(0);
        }

        free(hostname);
    }

    int result = tls_protocol->parse_packet(tls_sni_data, good[0].packet, good[0].packet_len, NULL);
    assert(result == -3);

    char *hostname = NULL;
    result = tls_protocol->parse_packet(NULL, good[0].packet, good[0].packet_len, &hostname);
    assert(result == -3);

    for (struct Test *test = bad; test < bad + sizeof(bad) / sizeof(struct Test); test++) {
        char *hostname = NULL;

        int result = tls_protocol->parse_packet(tls_sni_data, test->packet, test->packet_len, &hostname);

        // parse failure or not "localhost"
        assert(result < 0 ||
               hostname == NULL ||
               strcmp("localhost", hostname) != 0);

        free(hostname);
    }

    free(tls_sni_data);
    free(tls_alpn_data);

    return 0;
}

